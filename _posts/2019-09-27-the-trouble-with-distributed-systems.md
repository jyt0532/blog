---
layout: post
title: Designing Data-Intensive Application - The Trouble with Distributed Systems
comments: True 
subtitle: 分佈式系統的麻煩
tags: systemDesign 
author: jyt0532
excerpt: 
---

這是Designing Data-Intensive Application的第二部分第四章節: 分佈式系統的麻煩

本文所有圖片或代碼來自於原書內容
{% include copyright.html %}

## 前言

在前幾章中反覆出現的問題是 系統該如何處理錯誤情況 比如[副本故障切換](/2019/02/12/replication/#section-4) [複製延遲](/2019/02/12/replication/#複製延遲問題) 或是[事務控制](/2019/04/29/weak-isolation-levels/)

即使我們在之前談了很多錯誤 但我們還不夠悲觀 這篇文章我們要把悲觀最大化 假設任何可能出錯的東西都出錯

![Alt text]({{ site.url }}/public/pessimistic.jpeg)

我們會討論所有分布式系統**實踐上**可能會遇到的問題 了解哪些東西是我們能依賴的 哪些東西是我們不能過分依賴的

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
本章對分佈式系統中可能出現的問題進行徹底的悲觀和沮喪的總結 我們會討論

1.網絡的問題（“無法訪問的網絡”

2.時鐘和時序問題（“不可靠時鐘”）

3.我們將討論他們可以避免的程度。 所有這些問題的後果都是困惑的，

所以我們將探索如何思考一個分佈式系統的狀態，

以及如何推理髮生的事情（“知識，真相和謊言”）
@@@@@@@@@@@@@@@@@

### 故障與部分失效

單個計算機上的軟體沒有根本性的不可靠原因 當硬體正常工作時 相同的操作總是產生相同的結果 我們稱為deterministic 如果你有硬體上的問題 那你通常會是整個系統故障 所以一個跑軟體的個人計算機 要馬功能完好 要馬整組壞掉 不會介於兩者之間

但如果你是運行在多台計算機上的軟體時 那情況就完全不同 分布式系統並不是理想的模型很有可能系統的**某部分**會以不可預知的方式被破壞 我們稱為**部分失效(partial failure)** 頭痛的地方在於部分失效是**不確定性的(nonderterministic)**

如果你試圖想做涉及多個節點和網路的事情 這有時會成功有時會失敗 更慘的是如果是網路壞掉 你甚至無法知道你想做的事是否成功了 因為消息通過網路傳播的時間也是不確定的

這種不確定性和部分失效的可能性 使得分佈式系統難以工作


#### 雲計算與超級計算機

關於如何建構一個大型計算機有一個光譜

1.光譜的一端 是使用HPC(High-performance computing) 就是一個擁有數千CPU的超級猛電腦 可以用來計算密集的計算機任務 比如說天氣預報或是分子動力學

2.光譜的另外一端 則是雲計算(cloud computing) 通常是多個數據中心以乙太網路連結 彈性的按照需求/流量計費

3.一般企業使用的數據中心模型就是介於兩者之間

在光譜的不同地方 會導致不同的故障處理方式 在超級計算機的那一端 作業通常會不時地會將計算的狀態存盤到持久存儲中 如果一個節點出現故障 通常的解決方案是簡單地停止整個集群的工作負載 故障節點修復後 計算從上一個檢查點重新開始

因此 超級計算機更像是一個單節點計算機而不是分佈式系統 它通過讓部分失敗升級為完全失敗來處理部分失敗

但在本書中 我們希望處理的是互聯網服務的系統 這些系統通常與超級計算機有很大不同

1.許多與互聯網有關的應用程序都是Online的 我們必須要一直available! 讓服務暫停是不可接受的 不像天氣預測的批處理計算 可以隨時停止之後重新啟動

2.超級計算機通常由專用硬件構建而成 每個節點相當可靠 雲服務的節點是由商品機器構建而成的 雖然因為規模經濟一次購買大量比較便宜 但具有較高的故障率

3.超級計算機通常使用專門的網絡拓撲結構 例如多維網格和環面 這些為HPC工作負載提供了更好的性能 大型數據中心網路則是基於IP和已太網 以閉合拓撲排列提供更高的二等分帶寬

4.系統越大 其組件之一就越有可能發生變化 當你修好一個壞掉的東西時 別的東西可能也壞了 在一個有成千上萬個節點的系統中 我們可以合理的認為總是有一些東西壞掉了 所以你必須一直分配部分的資源在修理節點上

5.如果系統可以容忍發生故障的節點 並繼續保持整體工作狀態 那麼這對於操作和維護非常有用 比如[滾動升級](/2019/01/24/encoding-and-evolution/)(一次重新啟動一個節點 系統繼續服務用戶不中斷)

6.在地理位置分布部署中(保持數據在地理位置上接近用戶以減少訪問延遲) 通信很可能通過互聯網進行 與本地網絡相比 通信速度緩慢且不可靠 超級計算機通常假設它們的所有節點都靠近在一起 


如果要使分佈式系統工作 就必須接受部分故障的可能性 並在軟件中建立容錯機制

換句話說 我們需要利用**不可靠的組件構建一個可靠的系統** 別忘了沒有完美的[可靠性](/2019/01/05/reliable-scalable-and-maintainable-application/) 我們需要理解我們可以實際承諾的限制

### 不可靠的網路


